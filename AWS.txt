AWS

Region   Name	Region	Endpoint
US East (N. Virginia)	us-east-1	
US West (N. California)	us-west-1	
US West (Oregon)	    us-west-2



### AWS CLI <= Install and Configure ###

$ sudo pip install awscli --ignore-installed six 		<= 1.16 EKS Works
--------------------------------------------------------------------------------------------
	# Alternative Installation using CentOS Repository YUM
	https://devopsmates.com/install-configure-aws-cli-amazon-web-services-command-line-interface/
	yum install epel-release –y
	yum install python-pip –y
	pip install awscli
	pip install –upgrade awscli
	aws –version			<=1.14  !Not supporting the ESK(starts on 1.15.32)yet
	aws help 
--------------------------------------------------------------------------------------------

$ aws --version
	aws-cli/1.16.115 Python/3.6.7 Linux/3.10.0-957.1.3.el7.x86_64 botocore/1.12.105   <= EKS Works

$ aws configure
	AWS Access Key ID [None]: 
	AWS Secret Access Key [None]: 
	Default region name [None]: us-west-2  <= Oregon
	Default output format [None]: json
	
$ aws configure --profile=clusterAdmin					<= Specific AWS USER account credential
	AWS Access Key ID [****************UVFA]:
	AWS Secret Access Key [****************KJ2l]:
	Default region name [us-region-2]: us-west-2		<= Oregon
	Default output format [None]: json					<= ONLY JSON WORKS!!!! 
-------------------------------------------------------------------------------
# Configuration test
-------------------------------------------------------------------------------
$ aws s3 ls
	2017-02-27 20:39:36 backup-jenkins-sign
	2017-05-22 16:10:49 mobile-xpromo
-------------------------------------------------------------------------------
### how to get Canonical ID ###
-------------------------------------------------------------------------------
$ aws s3api list-buckets
{
    "Owner": {
        "DisplayName": "aws-gdpr",
        "ID": "25c4bb815a498aa63ffee0cedfd35798858a12cc0897ef268fa0073ad729ef2e"  <= Canonical ID
    },
-------------------------------------------------------------------------------
# Add to Environment Variable
-------------------------------------------------------------------------------
$ env | grep AWS										<= If no, add 
$ export AWS_PROFILE=clusterAdmin
  $ echo AWS_PROFILE=clusterAdmin >> .bash_profile 		<= .bash_profile <= login shell 
														<= .bashrc 		 <= after login user shell
  
$ aws eks update-kubeconfig --name classCluster	
	Added new context arn:aws:eks:us-west-2:688595016292:cluster/classCluster 
	to /home/awseks/.kube/config


$ aws eks list-clusters
	{
		"clusters": [
			"classCluster"			<= Cluster Name
		]
	}
-------------------------------------------------------------------------------	










##############################################################################
### EKS  (Elastic Kubernetes Service)
#   Training: https://www.linkedin.com/learning/running-kubernetes-on-aws-eks
##############################################################################


--------------------------------------------------------------------------------------------
EKS Support Regions 
--------------------------------------------------------------------------------------------
https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/
us-west-2 (Oregon)
us-east-1 (N. Virginia)
us-east-2 (Ohio)
Ireland, Frankfurt, London,	Paris, Stockholm
Singapore, Tokyo, Sydney, Seoul, Mumbai
--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------
### Gether Info ###
--------------------------------------------------------------------------------------------
IAM-ROLE-ARN: arn:aws:iam::688595016292:role/Cluster_EKS_Role

VPC-ID:vpc-0121526bc433d8e2b
SECURITY-GROUP-ID:sg-09222c96502064a3a
SUBNET-IDS:subnet-09442239f4e596b6d,subnet-069fb4ed48718a9f7,subnet-05a8b3907455065ce

NODE-ROLE-ARN:

LABEL-NODE-ROLE-ARN:

USER_ARN:
--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------
1. Create IAM Accounts and Policy for CRUD operations 
--------------------------------------------------------------------------------------------

  Create 2 Policies for EKS and CloudFormation Admins

Name: AdminEKSPolicy	
Name: AdminCloudFormationPolicy

Name: AdminEKSPolicy
----------------------------------------------
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",			<= Full permisson
            "Action": [
                "eks:*"					<= ARN EKS
            ],
            "Resource": "*"
        }
    ]
}
----------------------------------------------
Name: AdminCloudFormationPolicy			<= CM Tool
----------------------------------------------
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",			<= Full permisson
            "Action": "*",
            "Resource": "*"				<= ARN ALL
        }
    ]
}
----------------------------------------------

Create Roll 
# ClusterEKSRoll

EKS 



##################################################################

--------------------------------------------------------------------------------------------
IAM: Creating ClusterAdmin and ClusterUser accounts
--------------------------------------------------------------------------------------------
User #1:  clusterAdmin

 - eks admin policy
 - k8s admin "system:master" group
 
  Add policies:
  
   AdminEKSPolicy					<= Newly created by me
   AdminCloudFormationPolicy		<= Newly created by me
   
   AmazonEKSServicePolicy 			<= From Existing Policy
   AmazonEKSClusterPolicy 			<= From Existkuing Policy

User #2: clusterUser

  Add policies: 
 - no IAM policies
 - k8s admin "system:master" group
 - AdminEKSPolicy					<= NEW

--------------------------------------------------------------------------------------------
CloudFormation - Create Stack VPC Template From S3
--------------------------------------------------------------------------------------------
https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-08-30/amazon-eks-vpc-sample.yaml
Check Region first

Create Stack
	Select a sample template from S3
	
Copy from :
VPC-ID:
SECURITY-GROUP-ID:
SUBNET-IDS:


Key	Value	Description	Export Name
SecurityGroups	sg-09222c96502064a3a		
VpcId			vpc-0121526bc433d8e2b		
SubnetIds		subnet-09442239f4e596b6d,subnet-069fb4ed48718a9f7,subnet-05a8b3907455065ce 


-------------------------------------------------------------------------------
# Remote Tools Setup
-------------------------------------------------------------------------------
  1. Install "kubectl" 
	https://kubernetes.io/docs/tasks/tools/install-kubectl/
-------------------------------------------------------------------------------
  Linux:
	curl -LO https://storage.googleapis.com/kubernetes-release/release/\
		$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  MacOS:
	curl -LO https://storage.googleapis.com/kubernetes-release/release/\
		$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl

	$ kubectl version --short --client
	
-------------------------------------------------------------------------------
  2. Download "aws-iam-authenticator" binary:
	https://docs.aws.amazon.com/eks/latest/userguide/configure-kubectl.html
	-------------------------------------------------------------------------------
  Linux:
	curl -sLO https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator
  MacOS:
	curl -sLO https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator
	
  $ chmod + x 	aws-iam-authenticator
  $ mv aws-iam-authenticator /usr/lcoal/bin   			<= echo $PATH location
  
-------------------------------------------------------------------------------
  3. Install "AWS CLI" 
	https://docs.aws.amazon.com/cli/latest/userguide/installing.html
-------------------------------------------------------------------------------
	$ sudo pip install awscli --ignore-installed six 		<= 1.16 EKS Works
	$ pip install awscli --upgrade --user
-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
# Create EKS Cluster from AWS Console
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
# Configuration on Linux Shell
-------------------------------------------------------------------------------
  Config CLI for AWS and Kubectl
  $ aws configure
	  AWS Access Key ID [****************UVFA]:
	  AWS Secret Access Key [****************KJ2l]:
	  Default region name [us-west-2]: 				<= Oregon
	  Default output format [json]: yaml
   
    SYNOPSIS
     aws configure [--profile profile-name]  
	
	$ aws configure --profile=clusterAdmin
	
	$ export AWS_PROFILE=clusterAdmin
	# $ echo "export AWS_PROFILE=clusterAdmin" >> .bash_profile
	
	$ aws eks --region us-west-2 update-kubeconfig --name classCluster
	  Updated context arn:aws:eks:us-west-2:688595016292:cluster/classCluster in /home/awseks/.kube/config

	$ aws eks list-clusters			<= Get EKS cluster info
	{
		"clusters": [
			"classCluster"
		]
	}
  
  # Testing
	$ kubectl get nodes				<= to check
	$ kubectl get pods				<= to check


-------------------------------------------------------------------------------
# Adding Wokers(Nodes) to EKS 
-------------------------------------------------------------------------------
Go to CloudFormation -> Create a New stack 

From S3 template
https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-08-30/amazon-eks-nodegroup.yaml

Stack Name: eksWorkerNodesStack

EKS Cluster
	Cluster Name: classCluster
	ClusterControlPlaneSecurityGroup: Learning-EKS-VPC
	NodeGroupName:workerNodes
	NodeAutoScaling size: 1~3		<= Min ~ max size of Node Group AutoScaleGroup.
	NodeVolumeSize: 20 				<= default
	NodeImageId: ami-0c28139856aaf9c3b		<= us-west-2(Oregon) AMI
-------------------------------------------------------------------------------
	Amazon EKS-Optimized AMI
	https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html
-------------------------------------------------------------------------------
	KeyName:eksAdmin		<= EC2 access PEM key (EC2 -> Create key Pair)

Worker Network Configuration
	VpcId	: vpc-xxx(192.168.0.0/16..)
	Subnets	: subnet1(192.168.64.0./18...)
			  subnet2(192.168.128.0./18...)
			  subnet3(192.168.192.0./18...)			

Options:  <= pass on this		
Check on Agree then Click on Create!
eksWorkerNodesStack 2019-03-04 CREATE_IN_PROGRESS NOT_CHECKED Amazon EKS - Node Group 


-------------------------------------------------------------------------------
# Debug	connecting AWS EKS clusterAdmin
  
  # Check Who's ID is used for connection 
  $ aws sts get-caller-identity			<= AWS Security Token Service (STS)
	{
      "UserId": "AIDAJC4NG62FQHAPKEYRK",
      "Account": "688595016292",
      "Arn": "arn:aws:iam::688595016292:user/clusterAdmin"
	}

  $ kubectl config view
    apiVersion: v1
	clusters:
		- cluster:
			certificate-authority-data: DATA+OMITTED
			server: https://F08A5CEEF5AC38E949E4AA91C2FE028D.sk1.us-west-2.eks.amazonaws.com
			name: arn:aws:eks:us-west-2:688595016292:cluster/classCluster
			......
			
  $ kubectl get svc --v=10				<= --v=5  verbose level 5
  
  # Version Check
  $ aws --version
		aws-cli/1.16.115 Python/3.6.7 Linux/3.10.0-957.1.3.el7.x86_64 botocore/1.12.105
		
  $ kubectl version --short --client
		Client Version: v1.13.4
	


-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------













































































































































##############################################################################################################
1. CloudTrail
##############################################################################################################

	a. CloudTrail Viewer Tool
	https://github.com/githublemming/CloudTrailViewer/releases

# Create a S3 bucket	
$aws s3api create-bucket --bucket bnea-cloudtrail-bucket --region us-east-1
{
    "Location": "/bnea-cloudtrail-bucket"
}

# Create a Policy
##############################################################################
{
	"Version": "2012-10-17",
	"Statement": [{
			"Sid": "AWSCloudTrailAclCheck20150319",
			"Effect": "Allow",
			"Principal": {
				"Service": "cloudtrail.amazonaws.com"
			},
			"Action": "s3:GetBucketAcl",
			"Resource": "arn:aws:s3:::bnga-cloudtrail-bucket"
		},
		{
			"Sid": "AWSCloudTrailWrite20150319",
			"Effect": "Allow",
			"Principal": {
				"Service": "cloudtrail.amazonaws.com"
			},
			"Action": "s3:PutObject",
			"Resource": "arn:aws:s3:::bnea-cloudtrail-bucket/[optional prefix]/AWSLogs/myAccountID/*",
			"Condition": {
				"StringEquals": {
					"s3:x-amz-acl": "bucket-owner-full-control"
				}
			}
		}
	]
}
##############################################################################













